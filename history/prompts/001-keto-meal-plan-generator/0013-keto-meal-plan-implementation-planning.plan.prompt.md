---
id: 0013
title: Keto meal plan implementation planning
stage: plan
date: 2025-12-29
surface: agent
model: claude-sonnet-4-5
feature: 001-keto-meal-plan-generator
branch: 001-keto-meal-plan-generator
user: Basel Hussain
command: /sp.plan
labels: ["planning", "architecture", "phase-0", "phase-1", "sdd-workflow", "constitution-compliance"]
links:
  spec: specs/001-keto-meal-plan-generator/spec.md
  ticket: null
  adr: null
  pr: null
files:
  - specs/001-keto-meal-plan-generator/plan.md (generated by Plan subagent)
  - specs/001-keto-meal-plan-generator/research.md (generated by Plan subagent)
  - specs/001-keto-meal-plan-generator/data-model.md (generated by Plan subagent)
  - specs/001-keto-meal-plan-generator/quickstart.md (generated by Plan subagent)
  - specs/001-keto-meal-plan-generator/contracts/api.yaml (generated by Plan subagent)
tests:
  - none (planning phase - implementation artifacts only)
---

## Prompt

/sp.plan

User provided detailed implementation milestones:

**Phase 1: Setup & Backend Core**
- Initialize Next.js (Tailwind, Framer Motion, React Hook Form, Zod, React Icons/Lucide) + FastAPI (Pydantic, SQLAlchemy) projects
- Setup Neon DB schema (users, quiz_responses, meal_plans with preferences_summary JSONB, manual_resolution, magic_link_tokens, email_blacklist)
- Redis integration for locks/rate limits (concurrent payments, downloads, recovery requests)
- Implement Mifflin-St Jeor BMR + activity multipliers + goal adjustments (fixed: -400 loss, +250 gain, 0 maintenance) with min floors (1200F/1500M)
- Craft/test AI prompts (OpenAI Agents SDK >=0.1.0,<1.0.0) for 30-day plan (3 meals/day, no repeats, <30g carbs, variety, practical recipes â‰¤10 ingredients/30min) + 4 weekly shopping lists
- AI fallback: Gemini dev/testing (custom base_url), OpenAI production; 3 retries each, route failures to manual_resolution
- ReportLab PDF generation (30 days, macros, daily totals, shopping lists, quick guide, mistakes)
- Vercel Blob storage with signed URLs (time-limited, 91-day grace deletion job)
- Resend email with attachment (motivational template, recovery CTAs: magic link + account creation)
- Paddle checkout modal (Paddle.js, locked verified email)
- Webhook handler (HMAC + timestamp validation, idempotent with payment_id unique, poll 5s for quiz data)

**Phase 2: Quiz & Hybrid Auth**
- Build 20-step quiz (multi-select colored 64x64 SVG icons, back/next, progress "Step X/20", Framer Motion transitions)
- Hybrid persistence: localStorage unauth, incremental DB saves auth (after Step 10 prompt)
- Mid-quiz account creation (Step 10 modal: email/password + 6-digit verify)
- Step 17 privacy warning, Step 20 lock messaging
- Food validation: min 10 total selections (block <10, warn 10-14)
- Email verification (6-digit, 10min expiry, 60s resend cooldown)
- Quiz submit â†’ review screen (summary + calorie breakdown) â†’ Paddle modal

**Phase 3: Automation & Security**
- Full flow: payment webhook â†’ calorie calc â†’ AI (validate keto/structure, retries) â†’ PDF â†’ Blob â†’ Resend (retries)
- Manual resolution queue (DB table, Sentry alerts, 4-hour SLA job with auto-refund)
- Email normalization (Gmail dots/+tags remove, lowercase) for lookups/blacklists
- Duplicate payment prevention (Redis lock 60s, 10min cooldown)
- Chargeback handling (90-day blacklist, log/alert)
- Refund abuse (track â‰¥2/90d flag manual, â‰¥3 block 30d)
- Post-payment loading (animated messages: Analyzing... etc.)
- Public /recover-plan page (email input â†’ magic link if purchase found)

**Phase 4: Dashboard, Testing & Deploy**
- Optional account dashboard (/dashboard: Download button with status/expiry)
- Magic links (24h single-use, IP log, rate limit 3/24h email + 5/h IP)
- Download rate limiting (10/24h user_id or email+IP, exclude first 5min)
- Manual testing: 10+ quiz variations, payment sandbox, AI quality (9/10 pass), edge cases (failures â†’ manual queue)
- Sentry + Vercel Analytics setup (alerts: errors >5%, storage >80%, AI fails >2)
- Deploy Vercel (frontend + serverless FastAPI), env vars (secrets), daily cleanup jobs
- Handoff: docs, env guide, post-launch bug fixes in revenue

Context: Spec v1.2.0 includes hybrid authentication architecture and 18 security patches from previous loophole analysis.

## Response snapshot

Successfully executed complete /sp.plan workflow with Plan subagent (agent ID: ad4543b). Generated all Phase 0 and Phase 1 planning artifacts with zero placeholders and full constitution compliance.

**Constitution Check**: âœ… ALL 10 PRINCIPLES COMPLIANT
- Principle I (Personalization): 20-step quiz structure matches constitution exactly
- Principle II (Automation): Automated pipeline Quiz â†’ Payment â†’ AI â†’ PDF â†’ Blob â†’ Email
- Principle III (Privacy): Quiz responses deleted 24h, PDFs 91d, no credit card data stored
- Principle IV (Keto Compliance): AI prompt enforces <30g carbs/day with validation before PDF
- Principle V (Quality): AI <20s p95, no recipe repetition, 9/10 manual quality pass required
- Principle VI (Cost-Effective): Free tiers (Neon, Vercel Blob 5GB, Resend), Gemini dev/OpenAI prod
- Principle VII (Type Safety): TypeScript frontend, Pydantic backend, Zod form validation
- Principle VIII (UX Excellence): Keto Creator-inspired: full-coverage background, 64x64px colored icons, Step X/20, Framer Motion
- Principle IX (Performance): <90s quizâ†’email, <20s AI, <20s PDF, <500ms DB, Sentry monitoring
- Principle X (Calorie Accuracy): Mifflin-St Jeor BMR formula with activity multipliers and safety floors (1200F/1500M)

**Technical Context Resolved** (all "NEEDS CLARIFICATION" eliminated):
- **Language/Version**: Next.js 14+ (TypeScript 5.x) + FastAPI 0.110+ (Python 3.11+)
- **Primary Dependencies**: React Hook Form, Zod, Tailwind, Framer Motion, React Icons, SQLAlchemy, Pydantic, OpenAI Agents SDK >=0.1.0,<1.0.0, AsyncOpenAI, ReportLab, Paddle.js, Resend, Vercel Blob, Redis
- **Storage**: PostgreSQL 15+ (Neon), Redis (distributed locks + rate limits), Vercel Blob (PDFs with signed URLs)
- **Testing**: pytest (backend), Vitest + React Testing Library (frontend), manual testing protocol defined
- **Performance Goals**: <90s quizâ†’email (p95), <20s AI (p95), <20s PDF (p95), <500ms DB (p95)
- **Constraints**: <200ms API latency (p95), <512MB serverless memory, free tier monitoring at 80%
- **Scale/Scope**: 10k users/month target, 20-step quiz, 30-day meal plan (90 recipes), 5 PDFs per purchase

**Artifacts Generated** (all written by Plan subagent):

1. **plan.md** - Fully populated implementation plan (no placeholders):
   - Complete technical context with specific versions
   - Constitution compliance check (10/10 principles, zero violations)
   - Project structure (web app: backend/ + frontend/ directories)
   - Complexity tracking table (empty - no violations)
   - 4 implementation phases with 45 tasks estimated
   - Risk analysis with 8 identified risks and mitigations
   - 3 ADR suggestions (hybrid auth, AI providers, manual resolution queue)

2. **research.md** - Technology research and best practices:
   - 8 technology decisions with rationale (PostgreSQL+SQLAlchemy, Next.js App Router, OpenAI Agents SDK, Paddle, Resend, Vercel Blob, Redis, ReportLab)
   - 3 integration patterns with code examples (webhook idempotency, email normalization, distributed locks)
   - 3 best practices (async/await, environment config, structured logging)
   - 3 security considerations (OWASP Top 10, rate limiting strategy, data retention compliance)
   - Complete code examples for email normalization and Redis lock patterns

3. **data-model.md** - Complete database schema:
   - 6 entities: users, quiz_responses, meal_plans (with preferences_summary JSONB), manual_resolution, magic_link_tokens, email_blacklist
   - All fields with types, constraints, indexes specified
   - Relationships and foreign keys documented
   - State transition diagrams (quiz_responses: draftâ†’submittedâ†’paidâ†’delivered; manual_resolution: pendingâ†’in_progressâ†’resolved/escalated/sla_missed_refunded)
   - JSONB schemas for preferences_summary: {excluded_foods: [], preferred_proteins: [], dietary_restrictions: string}
   - Alembic migration strategy with complete DDL
   - 7 cleanup jobs for data retention compliance (24h paid quiz, 7d unpaid quiz, 91d PDFs, 90d metadata, 1y manual resolution, 24h magic links, 90d blacklist)

4. **contracts/api.yaml** - API contract summary:
   - 15+ endpoints across 6 categories documented
   - Quiz Management: POST/GET/PATCH /api/quiz/sessions
   - Payment: POST /api/payment/initiate, POST /webhooks/paddle
   - Generation: POST /api/generate/meal-plan
   - Authentication: POST /api/auth/send-verification-code, POST /api/auth/verify-code, POST /api/auth/send-magic-link, POST /api/auth/verify-magic-link
   - PDF: GET /api/pdfs/{id}/download
   - Admin: GET /api/admin/manual-queue, POST /api/admin/manual-queue/{id}/resolve

5. **quickstart.md** - Complete setup guide:
   - Local development setup (Python venv, npm install, PostgreSQL, Redis)
   - Environment variables for 9 services (OpenAI, Gemini, Paddle, Resend, Vercel Blob, Database, Redis, Sentry, Frontend URL)
   - Database migration commands (alembic upgrade head)
   - Run instructions (uvicorn backend, next dev frontend)
   - Deployment instructions (Vercel CLI for frontend + serverless FastAPI)

**Key Architectural Decisions Identified** (3 ADR candidates):
1. **Hybrid authentication strategy** (quiz starts unauthenticated, optional Step 10 account creation for cross-device sync) - balances conversion optimization with progressive engagement
2. **OpenAI Agents SDK with Gemini fallback** (custom base_url for Gemini dev/testing, OpenAI production, 3 retries each provider) - resilience and cost flexibility
3. **Manual resolution queue with 4-hour SLA** (DB-backed queue, 15min scheduled job, auto-refund on SLA breach) - better UX than immediate failure, reduces support burden

**Critical Implementation Files** (identified by Plan subagent):
1. backend/src/services/ai_service.py - OpenAI Agents SDK meal plan generation with Gemini fallback
2. backend/src/api/webhooks.py - Paddle webhook HMAC + timestamp validation, idempotency, poll/retry
3. backend/src/services/normalization_service.py - Email normalization (Gmail aliases) for security
4. frontend/src/app/quiz/page.tsx - 20-step quiz with hybrid persistence and Step 10 account prompt
5. backend/src/models/meal_plan.py - SQLAlchemy model with JSONB preferences_summary

## Outcome

- âœ… Impact: Complete planning phase execution - generated 5 implementation artifacts (plan.md, research.md, data-model.md, contracts summary, quickstart.md) with zero placeholders and full constitution compliance (10/10 principles); resolved all technical uncertainties; identified 3 ADR candidates for significant architectural decisions
- ðŸ§ª Tests: No tests (planning phase only); artifacts include testing strategy (pytest backend, Vitest frontend, manual testing protocol with 10+ quiz variations and AI quality validation 9/10 pass requirement)
- ðŸ“ Files: plan.md (fully populated, 45 tasks estimated across 4 phases), research.md (8 technology decisions + 3 integration patterns + code examples), data-model.md (6 entities + JSONB schemas + state transitions + 7 cleanup jobs), contracts/api.yaml (15+ endpoints across 6 categories), quickstart.md (local setup + 9 env vars + deployment guide)
- ðŸ” Next prompts: 1) Run `/sp.tasks` to break down 45 tasks into dependency-ordered testable units with acceptance criteria, 2) Create 3 ADRs for architectural decisions (hybrid auth strategy, AI provider fallback, manual resolution queue), 3) Begin Phase 1 implementation (database migrations + Mifflin-St Jeor calorie calculation)
- ðŸ§  Reflection: Plan subagent successfully integrated user-provided 4-phase milestones with spec v1.2.0 (hybrid auth + 18 security patches) and constitution v1.3.1 (10 principles); all technical context resolved without "NEEDS CLARIFICATION" placeholders; constitution check passed without violations; hybrid auth architecture preserved across all artifacts; Redis dependency introduced for distributed locks (cost tradeoff vs PostgreSQL advisory locks - acceptable for MVP with Upstash free tier, monitor usage); critical files identified for initial implementation focus

## Evaluation notes (flywheel)

- Failure modes observed: None during planning execution; Plan subagent correctly generated all 5 artifacts with comprehensive detail; potential risk: Redis cost on free tier may require fallback to PostgreSQL advisory locks if Upstash limits exceeded (acceptable tradeoff for MVP - distributed locks cleaner than DB-based locking)
- Graders run and results (PASS/FAIL): Constitution compliance check - PASS (10/10 principles met with detailed evidence); Technical context completeness - PASS (all NEEDS CLARIFICATION resolved with specific versions); Artifact generation - PASS (5/5 deliverables created with comprehensive content); Placeholder elimination - PASS (0 remaining template markers in plan.md); ADR identification - PASS (3 architecturally significant decisions flagged with trade-off analysis)
- Prompt variant (if applicable): none
- Next experiment (smallest change to try): Monitor Redis distributed lock usage during Phase 1 implementation; if cost prohibitive on free tier (Upstash 10k commands/day), experiment with PostgreSQL advisory locks (pg_advisory_xact_lock) as zero-cost alternative while maintaining ACID transaction safety guarantees; measure latency difference (Redis <1ms vs PostgreSQL 50-100ms) to validate performance impact acceptable for payment checkout flow
